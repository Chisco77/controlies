
class controlies {

   $version="0.6.5-3"
   $paquete_client="controlies-client_0.6.5-3_all.deb"
   $paquete_thinclient="controlies-thinclient_0.6.5-3_all.deb"

#Paquete para el seguimiento de equipos y usuarios.

   file {"/root/$paquete_client":
		owner => root, group => root, mode => 755,
		source => "puppet:///controlies/$paquete_client",
		notify => Exec["instala_controlies_client"]
   }

   exec { "instala_controlies_client":
		path => "/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin",
		command => "dpkg -i --force-confnew  --force-overwrite $paquete_client; apt-get -f -y install ",
		cwd => "/root",
		unless => "dpkg -l | grep controlies-client | grep $version | grep ^ii",
		require => File["/root/$paquete_client"],
   }

#Paquete y configuracion del despertado automatico de los thinclients para el seguimiento de los mismos.

  case $use {
        "ltsp-server": {
			file {"/opt/ltsp/i386/root/$paquete_thinclient":
				owner => root, group => root, mode => 755,
				source => "puppet:///controlies/$paquete_thinclient",
				notify => Exec["instala_controlies_thinclient"]
			}

			exec { "instala_controlies_thinclient":
				path => "/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin",
				command => "chroot /opt/ltsp/i386 /usr/bin/dpkg -i --force-confnew  --force-overwrite /root/$paquete_thinclient",
                                           #No se incluye el montaje de proc en el comando. Si se pone daba problemas en la instalacion del paquete.
				unless => "chroot /opt/ltsp/i386 dpkg -l | grep controlies-thinclient | grep $version | grep ^ii",
				require => File["/opt/ltsp/i386/root/$paquete_thinclient"],
				notify => Exec["actualiza-imagen-controlies"]
			}


 	                file {"/usr/share/controlies-client/":
			        owner => root, group => root, mode => 755,
				ensure => directory,
				before => File["/usr/share/controlies-client/despierta_thinclients"],
			}


			file { "/usr/share/controlies-client/despierta_thinclients":
				owner => root, group => root, mode => 755,
				source => "puppet:///controlies/despierta_thinclients",
			}

			cron { revision-matinal:
				command => "/usr/share/controlies-client/despierta_thinclients",
				user    => root,
				hour    => 8,
				minute  => 15
			}

			#cron { revision-recreo:
			#   command => "/usr/share/controlies-client/despierta_thinclients",
			#   user    => root,
			#   hour    => 11,
			#   minute  => 25
			#}

			#cron { revision-vespertina:
			#   command => "/usr/share/controlies-client/despierta_thinclients",
			#   user    => root,
			#   hour    => 14,
			#   minute  => 45
			#}

			#Regeneracion imagen clientes

			exec { "actualiza-imagen-controlies":
				command => "/usr/sbin/ltsp-update-image --arch i386",
				refreshonly => true,
			}
		}
		default: {}
	}


#Seguimiento impresión, parchea un bug en pkpgcounter.

	file {"/usr/share/pyshared/pkpgpdls/zjstream.py":
		owner => root, group => root, mode => 644,
		source => "puppet:///controlies/zjstream.py",
        }        

#======================================================================================================================
#Reglas de limpieza de los rastros de la versión anterior de controlies:
#   Se quitan antiguos scripts y rastros de la version preliminar de controlies-seguimiento, antes de la debianización
#   para evitar que queden rastros inútiles de antiguas tareas
#======================================================================================================================

       file { "/root/scripts/despierta_thinclients": 
            ensure => absent,
       }

       exec { "limpia_crontab_dc":
                path => "/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin",
                command => "sed -i.bak '\/root\/scripts\/despierta_thinclients/d' /var/spool/cron/crontabs/root",
                onlyif => "grep '/root/scripts/despierta_thinclients' /var/spool/cron/crontabs/root"
       }

       file { "/root/scripts/seguimiento_equipo":
            ensure => absent,
       }

       exec { "limpia_crontab_se":
                path => "/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin",
                command => "sed -i.bak '\/root\/scripts\/seguimiento_equipo/d' /var/spool/cron/crontabs/root",
                onlyif => "grep '/root/scripts/seguimiento_equipo' /var/spool/cron/crontabs/root"
       }
 
       file { "/root/scripts/seguimiento_impresion":
               ensure => absent,
       }

       exec {"limpieza_gdm3":
                path => "/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin",
                command => "sed -i.bak '/equipo=$(hostname -s)/,+5d' /etc/gdm3/PostSession/Default",
                cwd => "/root",
                onlyif =>"grep 'equipo=$(hostname -s)' /etc/gdm3/PostSession/Default",
       }

       exec {"limpieza_gdm":
                path => "/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin",
                command => "sed -i.bak '/equipo=$(hostname -s)/,+5d' /etc/gdm/PostSession/Default",
                cwd => "/root",
                onlyif =>"grep 'equipo=$(hostname -s)' /etc/gdm/PostSession/Default",
       }



}

